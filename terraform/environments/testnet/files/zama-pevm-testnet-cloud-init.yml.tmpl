#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - curl
  - jq
  - socat
  - git

write_files:
  - path: /opt/zama-pevm-testnet/kurtosis/network_params.yaml
    permissions: "0644"
    content: |
      ${indent(6, network_params)}

  - path: /root/.config/kurtosis/kurtosis-config.yml
    permissions: "0644"
    content: |
      config-version: 2
      should-send-metrics: false
      kurtosis-clusters:
        docker:
          type: "docker"

  - path: /opt/zama-pevm-testnet/bootstrap.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      export HOME=/root
      export PATH=$PATH:/usr/local/bin

      ENCLAVE_NAME="zama-testnet"
      REPO_URL="${repo_url}"

      if [ -f /opt/zama-pevm-testnet/.bootstrap-complete ]; then
        echo "bootstrap already complete"
        exit 0
      fi

      # install kurtosis
      echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | \
        tee /etc/apt/sources.list.d/kurtosis.list
      apt-get update
      apt-get install -y kurtosis-cli

      # install docker compose plugin
      mkdir -p /usr/local/lib/docker/cli-plugins
      curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
        -o /usr/local/lib/docker/cli-plugins/docker-compose
      chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

      kurtosis engine start

      if ! kurtosis enclave inspect "$ENCLAVE_NAME" &>/dev/null; then
        kurtosis run \
          --enclave "$ENCLAVE_NAME" \
          github.com/ethpandaops/ethereum-package \
          --args-file /opt/zama-pevm-testnet/kurtosis/network_params.yaml
      else
        echo "enclave $ENCLAVE_NAME already exists, skipping deployment"
      fi

      kurtosis enclave inspect "$ENCLAVE_NAME"

      # extract dynamic ports assigned by kurtosis
      get_port() {
        kurtosis service inspect "$ENCLAVE_NAME" "$1" | grep "$2:" | sed -n 's/.*127\.0\.0\.1:\([0-9]*\).*/\1/p' | head -1
      }
      EL_METRICS_PORT=$(get_port el-1-geth-lighthouse metrics)
      CL_METRICS_PORT=$(get_port cl-1-lighthouse-geth metrics)
      EL_RPC_PORT=$(get_port el-3-geth-lighthouse rpc)

      echo "EL_METRICS_PORT=$${EL_METRICS_PORT}" > /opt/zama-pevm-testnet/.ports
      echo "CL_METRICS_PORT=$${CL_METRICS_PORT}" >> /opt/zama-pevm-testnet/.ports
      echo "EL_RPC_PORT=$${EL_RPC_PORT}" >> /opt/zama-pevm-testnet/.ports

      # clone repo for observability configs
      git clone "$REPO_URL" /opt/zama-pevm-testnet/repo || true

      # start observability stack with extracted ports
      cp /opt/zama-pevm-testnet/.ports /opt/zama-pevm-testnet/repo/observability/.env
      cd /opt/zama-pevm-testnet/repo/observability
      docker compose up -d

      # expose RPC on :8545 for external access
      if [ -n "$${EL_RPC_PORT:-}" ]; then
        socat TCP-LISTEN:8545,fork,reuseaddr TCP:127.0.0.1:$EL_RPC_PORT &
      fi

      touch /opt/zama-pevm-testnet/.bootstrap-complete

      echo "bootstrap done"
      echo "  rpc:       http://<PUBLIC_IP>:8545"
      echo "  grafana:   http://<PUBLIC_IP>:3000 (admin/admin)"
      echo "  prometheus: http://<PUBLIC_IP>:9090"

  - path: /opt/zama-pevm-testnet/port-forward.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      if [ -f /opt/zama-pevm-testnet/.ports ]; then
        source /opt/zama-pevm-testnet/.ports
        if [ -n "$${EL_RPC_PORT:-}" ]; then
          socat TCP-LISTEN:8545,fork,reuseaddr TCP:127.0.0.1:$EL_RPC_PORT
        fi
      fi

  - path: /etc/systemd/system/zama-pevm-testnet.service
    permissions: "0644"
    content: |
      [Unit]
      Description=zama-pevm-testnet bootstrap
      After=docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=true
      Environment=HOME=/root
      ExecStart=/opt/zama-pevm-testnet/bootstrap.sh
      StandardOutput=journal
      StandardError=journal
      TimeoutStartSec=1800

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/zama-rpc-forward.service
    permissions: "0644"
    content: |
      [Unit]
      Description=RPC port forwarder
      After=zama-pevm-testnet.service
      Requires=zama-pevm-testnet.service

      [Service]
      Type=simple
      ExecStart=/opt/zama-pevm-testnet/port-forward.sh
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker root
  - mkdir -p /root/.config/kurtosis
  - mkdir -p /opt/zama-pevm-testnet/kurtosis
  - chmod +x /opt/zama-pevm-testnet/bootstrap.sh
  - chmod +x /opt/zama-pevm-testnet/port-forward.sh
  - systemctl enable zama-pevm-testnet.service
  - systemctl enable zama-rpc-forward.service
  - /opt/zama-pevm-testnet/bootstrap.sh
