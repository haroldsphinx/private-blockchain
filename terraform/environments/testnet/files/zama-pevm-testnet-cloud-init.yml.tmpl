#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - curl
  - jq
  - git

write_files:
  - path: /opt/zama/env
    permissions: "0644"
    content: |
      NODE_NAME=${node_name}
      NODE_ROLE=${node_role}
      OWN_EIP=${own_eip}
      BOOTNODE_EIP=${bootnode_eip}
      BOOTNODE_PUBKEY=${bootnode_pubkey}
      BOOTNODE_ENR=${bootnode_enr}
      MONITORING_IP=${monitoring_private_ip}
      NETWORK_ID=12345

  - path: /opt/zama/telescope.yml
    permissions: "0644"
    content: |
      server:
        log_level: info
      metrics:
        global:
          scrape_interval: 15s
          external_labels:
            node: ${node_name}
          remote_write:
            - url: http://${monitoring_private_ip}:9090/api/v1/write
        wal_directory: /tmp/telescope
        configs:
          - name: blockchain
            host_filter: false
            scrape_configs:
              - job_name: geth
                metrics_path: /debug/metrics/prometheus
                static_configs:
                  - targets: ['localhost:6060']
              - job_name: lighthouse
                static_configs:
                  - targets: ['localhost:5054', 'localhost:5064']
      logs:
        positions_directory: /tmp/positions
        configs:
          - name: docker
            clients:
              - url: http://${monitoring_private_ip}:3100/loki/api/v1/push
            scrape_configs:
              - job_name: containers
                docker_sd_configs:
                  - host: unix:///var/run/docker.sock
                relabel_configs:
                  - source_labels: ['__meta_docker_container_name']
                    regex: '/(.*)'
                    target_label: 'container'
      integrations:
        node_exporter:
          enabled: true
        cadvisor:
          enabled: true
          docker_only: true

  - path: /opt/zama/bootstrap.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      [ -f /opt/zama/.done ] && exit 0

      curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
        -o /usr/local/lib/docker/cli-plugins/docker-compose
      chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

      git clone ${github_repo} /opt/zama/repo
      cd /opt/zama/repo/docker

      cp /opt/zama/telescope.yml telescope.yml
      ln -sf /opt/zama/repo/genesis genesis

      docker run --rm -v geth-data:/data -v $(pwd)/genesis/el:/genesis:ro \
        ethereum/client-go:v1.15.2 init --datadir=/data /genesis/genesis.json

      mkdir -p /var/lib/docker/volumes/geth-data/_data/geth
      cp genesis/nodekeys/${node_name}.key /var/lib/docker/volumes/geth-data/_data/geth/nodekey

      if [ "${node_role}" = "validator" ]; then
        docker run --rm \
          -v lighthouse-vc-data:/data \
          -v $(pwd)/genesis:/genesis:ro \
          sigp/lighthouse:v6.0.1 \
          lighthouse account validator import \
          --network=custom --testnet-dir=/genesis/cl --datadir=/data \
          --directory=/genesis/validator-keys/${node_name}/keys \
          --password-file=/genesis/validator-keys/${node_name}/secrets \
          --reuse-password
        COMPOSE_PROFILES=validator docker compose --env-file /opt/zama/env up -d
      else
        COMPOSE_PROFILES=rpc docker compose --env-file /opt/zama/env up -d
      fi

      touch /opt/zama/.done

  - path: /etc/systemd/system/zama.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Zama blockchain node
      After=docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=true
      ExecStart=/opt/zama/bootstrap.sh
      TimeoutStartSec=1800

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable docker && systemctl start docker
  - mkdir -p /opt/zama /usr/local/lib/docker/cli-plugins
  - systemctl enable zama && /opt/zama/bootstrap.sh
