#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - curl
  - jq
  - git

write_files:
  - path: /opt/zama-pevm-testnet/kurtosis/network_params.yaml
    permissions: "0644"
    content: |
      ${indent(6, network_params)}

  - path: /root/.config/kurtosis/kurtosis-config.yml
    permissions: "0644"
    content: |
      config-version: 2
      should-send-metrics: false
      kurtosis-clusters:
        docker:
          type: "docker"

  - path: /opt/zama-pevm-testnet/bootstrap.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      export HOME=/root
      export PATH=$PATH:/usr/local/bin

      ENCLAVE_NAME="zama-testnet"
      REPO_URL="${repo_url}"

      if [ -f /opt/zama-pevm-testnet/.bootstrap-complete ]; then
        echo "bootstrap already complete"
        exit 0
      fi

      echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | \
        tee /etc/apt/sources.list.d/kurtosis.list
      apt-get update
      apt-get install -y kurtosis-cli

      mkdir -p /usr/local/lib/docker/cli-plugins
      curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
        -o /usr/local/lib/docker/cli-plugins/docker-compose
      chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

      kurtosis engine start

      if ! kurtosis enclave inspect "$ENCLAVE_NAME" &>/dev/null; then
        kurtosis run \
          --enclave "$ENCLAVE_NAME" \
          github.com/ethpandaops/ethereum-package \
          --args-file /opt/zama-pevm-testnet/kurtosis/network_params.yaml
      else
        echo "enclave $ENCLAVE_NAME already exists, skipping deployment"
      fi

      kurtosis enclave inspect "$ENCLAVE_NAME"

      # extract ports for the observability docker-compose stack
      get_port() {
        kurtosis service inspect "$ENCLAVE_NAME" "$1" | grep "$2:" | sed -n 's/.*0\.0\.0\.0:\([0-9]*\).*/\1/p' | head -1
      }
      EL_METRICS_PORT=$(get_port el-1-geth-lighthouse metrics)
      CL_METRICS_PORT=$(get_port cl-1-lighthouse-geth metrics)
      EL_RPC_PORT=$(get_port el-3-geth-lighthouse rpc)

      cat > /opt/zama-pevm-testnet/.ports <<PORTSEOF
      EL_METRICS_PORT=$${EL_METRICS_PORT}
      CL_METRICS_PORT=$${CL_METRICS_PORT}
      EL_RPC_PORT=$${EL_RPC_PORT}
      PORTSEOF

      git clone "$REPO_URL" /opt/zama-pevm-testnet/repo || true

      cp /opt/zama-pevm-testnet/.ports /opt/zama-pevm-testnet/repo/observability/.env
      cd /opt/zama-pevm-testnet/repo/observability
      docker compose up -d

      touch /opt/zama-pevm-testnet/.bootstrap-complete

      PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 || echo "<PUBLIC_IP>")
      echo ""
      echo "bootstrap done â€” all ports bound to 0.0.0.0 via port_publisher"
      echo ""
      kurtosis enclave inspect "$ENCLAVE_NAME"
      echo ""
      echo "  observability grafana:    http://$PUBLIC_IP:3001 (admin/admin)"
      echo "  observability prometheus: http://$PUBLIC_IP:9091"
      echo "  alertmanager:             http://$PUBLIC_IP:9093"

  - path: /etc/systemd/system/zama-pevm-testnet.service
    permissions: "0644"
    content: |
      [Unit]
      Description=zama-pevm-testnet bootstrap
      After=docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=true
      Environment=HOME=/root
      ExecStart=/opt/zama-pevm-testnet/bootstrap.sh
      StandardOutput=journal
      StandardError=journal
      TimeoutStartSec=1800

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker root
  - mkdir -p /root/.config/kurtosis
  - mkdir -p /opt/zama-pevm-testnet/kurtosis
  - chmod +x /opt/zama-pevm-testnet/bootstrap.sh
  - systemctl enable zama-pevm-testnet.service
  - /opt/zama-pevm-testnet/bootstrap.sh
