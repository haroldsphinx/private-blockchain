#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - curl
  - jq

write_files:
  - path: /opt/zama-pevm-testnet/kurtosis/network_params.yaml
    permissions: "0644"
    content: |
      ${indent(6, network_params)}

  - path: /root/.config/kurtosis/kurtosis-config.yml
    permissions: "0644"
    content: |
      config-version: 2
      should-send-metrics: false
      kurtosis-clusters:
        docker:
          type: "docker"

  - path: /opt/zama-pevm-testnet/observability/docker-compose.yml
    permissions: "0644"
    content: |
      services:
        prometheus:
          image: prom/prometheus:latest
          container_name: prometheus
          restart: unless-stopped
          command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--web.enable-lifecycle"
            - "--storage.tsdb.path=/prometheus"
          ports:
            - "9090:9090"
          volumes:
            - /opt/zama-pevm-testnet/observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - /opt/zama-pevm-testnet/observability/rules.yml:/etc/prometheus/rules.yml:ro
          network_mode: host

        alertmanager:
          image: prom/alertmanager:v0.27.0
          container_name: alertmanager
          restart: unless-stopped
          command:
            - "--config.file=/etc/alertmanager/alertmanager.yml"
          ports:
            - "9093:9093"
          volumes:
            - /opt/zama-pevm-testnet/observability/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro

        grafana:
          image: grafana/grafana:10.4.5
          container_name: grafana
          restart: unless-stopped
          environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=admin
          ports:
            - "3000:3000"
          volumes:
            - /opt/zama-pevm-testnet/observability/grafana/provisioning:/etc/grafana/provisioning:ro

        node-exporter:
          image: prom/node-exporter:latest
          container_name: node-exporter
          restart: unless-stopped
          ports:
            - "9100:9100"
          volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro
          command:
            - '--path.procfs=/host/proc'
            - '--path.rootfs=/rootfs'
            - '--path.sysfs=/host/sys'

  - path: /opt/zama-pevm-testnet/observability/prometheus.yml
    permissions: "0644"
    content: |
      global:
        scrape_interval: 15s

      rule_files:
        - /etc/prometheus/rules.yml

      alerting:
        alertmanagers:
          - static_configs:
              - targets: ['localhost:9093']

      scrape_configs:
        - job_name: geth
          static_configs:
            - targets: ['localhost:32002']

        - job_name: lighthouse
          static_configs:
            - targets: ['localhost:33002']

        - job_name: node-exporter
          static_configs:
            - targets: ['localhost:9100']

        - job_name: rpc-probe
          metrics_path: /probe
          params:
            module: [http_2xx]
          static_configs:
            - targets: ['http://localhost:32017']
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - target_label: __address__
              replacement: localhost:9115

  - path: /opt/zama-pevm-testnet/observability/rules.yml
    permissions: "0644"
    content: |
      groups:
        - name: blockchain
          rules:
            - alert: ELNodeDown
              expr: up{job="geth"} == 0
              for: 1m
              labels:
                severity: critical
              annotations:
                summary: "Execution layer node down"

            - alert: CLNodeDown
              expr: up{job="lighthouse"} == 0
              for: 1m
              labels:
                severity: critical
              annotations:
                summary: "Consensus layer node down"

            - alert: NoNewBlocks
              expr: increase(eth_block_number[2m]) == 0
              for: 2m
              labels:
                severity: warning
              annotations:
                summary: "No new blocks in 2 minutes"

  - path: /opt/zama-pevm-testnet/observability/alertmanager.yml
    permissions: "0644"
    content: |
      global:
        smtp_smarthost: 'smtp.gmail.com:587'
        smtp_from: 'haroldsphinx@gmail.com'
        smtp_auth_username: 'haroldsphinx@gmail.com'
        smtp_auth_password: '${gmail_app_password}'

      route:
        group_by: ['alertname']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        receiver: email

      receivers:
        - name: email
          email_configs:
            - to: 'haroldsphinx@gmail.com'
              send_resolved: true

  - path: /opt/zama-pevm-testnet/observability/grafana/provisioning/datasources/datasources.yml
    permissions: "0644"
    content: |
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://localhost:9090
          isDefault: true

  - path: /opt/zama-pevm-testnet/observability/grafana/provisioning/dashboards/dashboards.yml
    permissions: "0644"
    content: |
      apiVersion: 1
      providers:
        - name: default
          folder: ''
          type: file
          options:
            path: /etc/grafana/provisioning/dashboards

  - path: /opt/zama-pevm-testnet/bootstrap.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      export HOME=/root
      export PATH=$PATH:/usr/local/bin

      ENCLAVE_NAME="zama-testnet"

      if [ -f /opt/zama-pevm-testnet/.bootstrap-complete ]; then
        echo "bootstrap already complete"
        exit 0
      fi

      echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | tee /etc/apt/sources.list.d/kurtosis.list
      apt-get update
      apt-get install -y kurtosis-cli

      mkdir -p /usr/local/lib/docker/cli-plugins
      curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
        -o /usr/local/lib/docker/cli-plugins/docker-compose
      chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

      kurtosis engine start

      if ! kurtosis enclave inspect "$ENCLAVE_NAME" &>/dev/null; then
        kurtosis run \
          --enclave "$ENCLAVE_NAME" \
          github.com/ethpandaops/ethereum-package \
          --args-file /opt/zama-pevm-testnet/kurtosis/network_params.yaml
      fi

      cd /opt/zama-pevm-testnet/observability
      docker compose up -d

      sleep 10
      curl -s -X POST http://localhost:3000/api/gnet/dashboards/14053 -u admin:admin -H "Content-Type: application/json" -d '{"inputs":[{"name":"DS_PROMETHEUS","type":"datasource","value":"Prometheus"}]}' || true
      curl -s -X POST http://localhost:3000/api/gnet/dashboards/16737 -u admin:admin -H "Content-Type: application/json" -d '{"inputs":[{"name":"DS_PROMETHEUS","type":"datasource","value":"Prometheus"}]}' || true

      touch /opt/zama-pevm-testnet/.bootstrap-complete

  - path: /etc/systemd/system/zama-pevm-testnet.service
    permissions: "0644"
    content: |
      [Unit]
      Description=zama-pevm-testnet bootstrap
      After=docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=true
      Environment=HOME=/root
      ExecStart=/opt/zama-pevm-testnet/bootstrap.sh
      StandardOutput=journal
      StandardError=journal
      TimeoutStartSec=1800

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker root
  - mkdir -p /root/.config/kurtosis
  - mkdir -p /opt/zama-pevm-testnet/kurtosis
  - mkdir -p /opt/zama-pevm-testnet/observability/grafana/provisioning/datasources
  - mkdir -p /opt/zama-pevm-testnet/observability/grafana/provisioning/dashboards
  - chmod +x /opt/zama-pevm-testnet/bootstrap.sh
  - systemctl enable zama-pevm-testnet.service
  - /opt/zama-pevm-testnet/bootstrap.sh
