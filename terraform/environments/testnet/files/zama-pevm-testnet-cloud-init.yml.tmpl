#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - curl
  - jq
  - socat
  - conntrack

write_files:
  - path: /opt/zama-pevm-testnet/kurtosis/network_params.yaml
    permissions: "0644"
    content: |
      ${indent(6, network_params)}

  - path: /opt/zama-pevm-testnet/argocd-values.yaml
    permissions: "0644"
    content: |
      ${indent(6, argocd_values)}

  - path: /opt/zama-pevm-testnet/argocd-apps/observability.yaml
    permissions: "0644"
    content: |
      ${indent(6, observability_app)}

  - path: /opt/zama-pevm-testnet/ingress/ingress.yaml
    permissions: "0644"
    content: |
      ${indent(6, ingress_manifest)}

  - path: /opt/zama-pevm-testnet/bootstrap.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      ENCLAVE_NAME="zama-testnet"
      DOMAIN="haroldsphinx.com"

      # install minikube
      curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
      install minikube-linux-amd64 /usr/local/bin/minikube
      rm minikube-linux-amd64

      # install kubectl
      curl -LO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      install kubectl /usr/local/bin/kubectl
      rm kubectl

      # install helm
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # install kurtosis
      echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | \
        tee /etc/apt/sources.list.d/kurtosis.list
      apt-get update
      apt-get install -y kurtosis-cli

      minikube start \
        --cpus=max \
        --memory=max \
        --disk-size=40g \
        --driver=docker \
        --force

      cp /root/.kube/config /opt/zama-pevm-testnet/kubeconfig
      chmod 644 /opt/zama-pevm-testnet/kubeconfig
      export KUBECONFIG=/opt/zama-pevm-testnet/kubeconfig

      minikube addons enable ingress
      kubectl wait --for=condition=available deployment/ingress-nginx-controller \
        -n ingress-nginx --timeout=120s

      # argocd
      kubectl create namespace argocd || true
      helm repo add argo https://argoproj.github.io/argo-helm
      helm repo update
      helm upgrade --install argocd argo/argo-cd \
        --namespace argocd \
        --values /opt/zama-pevm-testnet/argocd-values.yaml \
        --wait --timeout 5m

      # deploy the network
      kurtosis cluster set kube
      kurtosis engine restart
      kurtosis gateway &
      GATEWAY_PID=$!
      sleep 10

      kurtosis run \
        --enclave "$ENCLAVE_NAME" \
        github.com/ethpandaops/ethereum-package \
        --args-file /opt/zama-pevm-testnet/kurtosis/network_params.yaml

      kurtosis enclave inspect "$ENCLAVE_NAME"

      # observability + ingress
      kubectl apply -f /opt/zama-pevm-testnet/argocd-apps/
      kubectl apply -f /opt/zama-pevm-testnet/ingress/ingress.yaml

      # expose ingress on port 80
      kubectl port-forward svc/ingress-nginx-controller \
        -n ingress-nginx --address 0.0.0.0 80:80 &

      # direct RPC fallback on :8545 for tools that expect it
      INSPECT_OUTPUT=$(kurtosis enclave inspect "$ENCLAVE_NAME")
      EL_RPC_PORT=$(echo "$INSPECT_OUTPUT" | grep "el-3-geth" | grep "rpc:" | sed -n 's/.*127\.0\.0\.1:\([0-9]*\).*/\1/p' | head -1)
      if [ -n "$${EL_RPC_PORT:-}" ]; then
        socat TCP-LISTEN:8545,fork,reuseaddr TCP:127.0.0.1:$EL_RPC_PORT &
        echo "EL_RPC_PORT=$EL_RPC_PORT" > /opt/zama-pevm-testnet/.ports
      fi

      ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret \
        -o jsonpath="{.data.password}" 2>/dev/null | base64 -d || echo "n/a")

      echo "bootstrap done"
      echo "  rpc:      http://rpc.$DOMAIN"
      echo "  explorer: http://explorer.$DOMAIN"
      echo "  grafana:  http://grafana.$DOMAIN (admin/admin)"
      echo "  argocd:   http://argocd.$DOMAIN (admin/$ARGOCD_PASSWORD)"
      echo "  direct rpc fallback: http://<PUBLIC_IP>:8545"
      echo "  point *.$DOMAIN to this instance's public IP"

  - path: /etc/systemd/system/kurtosis-gateway.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Kurtosis Gateway
      After=docker.service
      Requires=docker.service

      [Service]
      Type=simple
      Environment=KUBECONFIG=/opt/zama-pevm-testnet/kubeconfig
      ExecStart=/usr/bin/kurtosis gateway
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

  - path: /opt/zama-pevm-testnet/ingress-forward.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      export KUBECONFIG=/opt/zama-pevm-testnet/kubeconfig

      sleep 15

      kubectl port-forward svc/ingress-nginx-controller \
        -n ingress-nginx --address 0.0.0.0 80:80 &

      if [ -f /opt/zama-pevm-testnet/.ports ]; then
        source /opt/zama-pevm-testnet/.ports
        if [ -n "$${EL_RPC_PORT:-}" ] && [ "$EL_RPC_PORT" != "0" ]; then
          socat TCP-LISTEN:8545,fork,reuseaddr TCP:127.0.0.1:$EL_RPC_PORT &
        fi
      fi

      wait

  - path: /etc/systemd/system/ingress-forward.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Ingress Port Forwarder
      After=kurtosis-gateway.service
      Requires=kurtosis-gateway.service

      [Service]
      Type=simple
      Environment=KUBECONFIG=/opt/zama-pevm-testnet/kubeconfig
      ExecStart=/opt/zama-pevm-testnet/ingress-forward.sh
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/zama-pevm-testnet.service
    permissions: "0644"
    content: |
      [Unit]
      Description=zama-pevm-testnet (minikube + Kurtosis + ArgoCD)
      After=docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=true
      Environment=KUBECONFIG=/opt/zama-pevm-testnet/kubeconfig
      ExecStart=/opt/zama-pevm-testnet/bootstrap.sh
      StandardOutput=journal
      StandardError=journal
      TimeoutStartSec=900

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable docker
  - systemctl start docker
  - mkdir -p /opt/zama-pevm-testnet/argocd-apps
  - mkdir -p /opt/zama-pevm-testnet/ingress
  - mkdir -p /opt/zama-pevm-testnet/kurtosis
  - chmod +x /opt/zama-pevm-testnet/bootstrap.sh
  - chmod +x /opt/zama-pevm-testnet/ingress-forward.sh
  - systemctl enable zama-pevm-testnet.service
  - systemctl enable kurtosis-gateway.service
  - systemctl enable ingress-forward.service
  - /opt/zama-pevm-testnet/bootstrap.sh
