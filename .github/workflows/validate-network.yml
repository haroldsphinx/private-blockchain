name: zama-pevm-testnet Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  TESTNET_IP: "52.22.192.77"
  RPC_PORT: 8545

jobs:
  validate:
    name: Validate Testnet Health
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify RPC endpoint responds
        run: |
          curl -sf -X POST http://$TESTNET_IP:$RPC_PORT \
            -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"web3_clientVersion","params":[],"id":1}' \
            --connect-timeout 10 --max-time 30

      - name: Check block production
        run: |
          BLOCK1=$(curl -sf -X POST http://$TESTNET_IP:$RPC_PORT \
            -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' | jq -r '.result')
          echo "Block at T+0: $BLOCK1"

          sleep 15

          BLOCK2=$(curl -sf -X POST http://$TESTNET_IP:$RPC_PORT \
            -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' | jq -r '.result')
          echo "Block at T+15s: $BLOCK2"

          if [ "$BLOCK1" = "$BLOCK2" ]; then
            echo "ERROR: No new blocks produced"
            exit 1
          fi

      - name: Check peer connectivity
        run: |
          PEERS=$(curl -sf -X POST http://$TESTNET_IP:$RPC_PORT \
            -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"net_peerCount","params":[],"id":1}' | jq -r '.result')
          PEER_COUNT=$((PEERS))
          echo "Peer count: $PEER_COUNT"
          if [ "$PEER_COUNT" -lt 1 ]; then
            echo "ERROR: No peers connected"
            exit 1
          fi

      - name: Check sync status
        run: |
          SYNCING=$(curl -sf -X POST http://$TESTNET_IP:$RPC_PORT \
            -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}' | jq -r '.result')
          if [ "$SYNCING" != "false" ]; then
            echo "WARNING: Node is syncing"
            echo "$SYNCING"
          fi

      - name: Check chain ID
        run: |
          CHAIN_ID=$(curl -sf -X POST http://$TESTNET_IP:$RPC_PORT \
            -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' | jq -r '.result')
          CHAIN_ID_DEC=$((CHAIN_ID))
          echo "Chain ID: $CHAIN_ID_DEC"
          if [ "$CHAIN_ID_DEC" != "12345" ]; then
            echo "ERROR: Unexpected chain ID (expected 12345)"
            exit 1
          fi
